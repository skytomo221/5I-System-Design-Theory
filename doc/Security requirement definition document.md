# セキュリティ要件定義書

## 認証

1.1 以下の箇所では、認証を実施すること

- 履歴
- 設定
- メッセージの評価を行うとき

1.2 以下の箇所では、認証済みの場合でも再認証を実施すること

- パスワード変更
- アカウント削除

この部分は、クロスサイト・リクエスト・フォージェリ(CSRF)に対する対応となる。
また、セッションハイジャックされた際にも、攻撃者が重要な情報にアクセス出来なくなるため、重要な箇所では再認証が必要である。

1.3 パスワードについて

- パスワード文字列は大小英字と数字と記号を含み、8文字以上12文字以内であること
- 画面（hidden パラメーターなどのソースコード内も含む）にパスワード文字列を表示しないこと
- パスワード文字列の入力フォームは input type="password"で指定すること
- ユーザが入力したパスワード文字列を次画面以降で表示しないこと
- パスワード文字列は「パスワード文字列＋salt（ユーザー毎に異なるランダムな文字列）」をハッシュ化したものと salt のみを保存すること
- ユーザ自身がパスワードを変更できる機能を用意すること

1.4 アカウントロック機能について

- 認証時に無効なパスワードで 10 回試行があった場合、最小 30 分間はユーザがロックアウトされた状態にすること
- ロックアウトは自動解除を基本とし、手動での解除は管理者のみ実施可能とすること

ログインの試行が簡単（1リクエストで完結するなど）な場合、システム的にあらゆるパスワードでのログイン試行を実施し、認証を突破する総当たり攻撃（ブルートフォースアタック）や辞書攻撃（辞書にある単語を総当り的に投げる）を受ける可能性がある。そのため、アカウントロックを行うことで、それを防ぐことができる。

## 認可（アクセス制御）

2.1 Webページや機能、データへのアクセスは認証情報・状態を元にして判別すること

## セッション管理

3.1 セッションの破棄について

- 認証済みのセッションが一定時間以上アイドル状態にあるときはセッションタイムアウトとし、サーバ側でセッションを破棄しログアウトすること（時間はサービスの内容に応じて調整すること）
- ログアウト機能を用意し、ログアウト実行時にはサーバー側でセッションを破棄すること

セッションがいつまでも残った状態になっていると、セッション・ハイジャックの危険が高まる。
過去にキャプチャしたパケットを使っての攻撃などが容易になるので、ターゲットを絞った攻撃ができてしまう。

3.2 セッション ID について

- Web アプリケーション開発ツールが提供するセッション管理機能を使用すること
- 上記のセッション管理機能の使用が困難な場合、セッション ID は 80 ビット（使用する文字が 16 進数の場合 20 文字）以上の文字列を使用すること
- 上記のセッション管理機能の使用が困難な場合、セッション ID はログインごとに乱数により生成すること
- セッション ID をクライアントと受け渡しする際は Cookie にのみ格納すること
- セッション ID の発行は認証成功後とすること
- 認証済みユーザーの特定はセッション ID でのみ行うこと

セッションIDはランダムでないと推測が可能になってしまう。
セッション・ハイジャックやセッション・フィクセーションを防ぐためには、推測や漏洩、盗聴などが出来ないようにすることが基本の対策である。

3.3 CSRF（クロスサイトリクエストフォージェリー）対策の実施について

- CSRF対策を実施すべき箇所では再認証の実施すること
- CSRF対策を実施すべき箇所で再認証の実施を提供することが困難な場合にはアクセスを POSTに限定し秘密情報の埋め込みと確認を実施すること

## パラメータ

4.1 URL パラメータにユーザーID やパスワードなどの秘密情報を格納しないこと

Refererなどで漏洩する可能性があるため、絶対に禁止である。

4.2 パラメータにパス名を含めないこと

パラメータにパス名を含めた場合、ディレクトリ・トラバーサルを受ける可能性がある。
基本的には、パラメータをそのままファイルのパスに入れるということ自体が禁止である。

4.3 アプリケーション要件に基づいて入力値の文字種や文字列長の検証を行うこと

サーバの脆弱性を突く（バッファ・オーバーフローなどの）ために、非常に長い文字列を送りつけたり、ヌル文字を含む文字列を送りつけたりということが行われる事がある。
事前に文字列のチェックを行い、パラメータをそのまま内部の関数に送ったりしないということが必要である。

## 文字列処理

5.1 クロスサイトスクリプティング（XSS）対策を講じること

- すべての HTML 出力で特殊文字（< > " ' &）をエスケープすること（ ' のエスケープはオプション扱い）
- ユーザの入力など、外部から入力した URL を出力するときは「`http://`」や「`https://`」で始まるもののみを許可すること
- 要素の内容やイベントハンドラ（onmouseover=””など）を動的に生成しないようにすること
- スタイルシートを外部サイトから取り込めないようにすること

ユーザが入力した文字が、HTMLとして解釈されたり、JavaScriptとして解釈されたりすることを禁止する必要がある。

5.2 HTML タグの属性値を「"」で囲うこと

5.3 SQL コマンドを組み立てる際にプレースホルダを使用すること

SQLインジェクションの標準的対策である。

5.4 HTTP レスポンスヘッダーの Content-Type に文字コードを指定すること

意図的に壊れたエンコーディングのデータをHTMLに埋め込ませることで、HTMLの解釈を誤らせ、Scriptタグの埋め込みを可能にしたりする攻撃があるため。

## HTTPS

## Cookie

## 画面設計

## その他

## 提出物

## 参考文献

この文書は、OWASP Japanのセキュリティ要件定義書を基に作られています。
